{
  "version": 3,
  "sources": ["../../../../Documents/Obra Nueva/obra-nueva-last/netlify/functions/hubspot-deals.ts"],
  "sourceRoot": "C:/Users/Zenova/AppData/Local/Temp/tmp-496-uecAf2rj8N1s",
  "sourcesContent": ["export async function handler(event: any, context: any) {\r\n  console.log('\uD83D\uDE80 Funci\u00F3n hubspot-deals iniciada');\r\n  console.log('\uD83D\uDCDD Event method:', event.httpMethod);\r\n\r\n  // Headers para CORS\r\n  const headers = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n  };\r\n\r\n  // Manejar CORS preflight\r\n  if (event.httpMethod === 'OPTIONS') {\r\n    console.log('\u2705 Respondiendo a preflight CORS');\r\n    return { statusCode: 200, headers, body: '' };\r\n  }\r\n\r\n  // Solo permitir POST\r\n  if (event.httpMethod !== 'POST') {\r\n    console.log('\u274C M\u00E9todo no permitido:', event.httpMethod);\r\n    return {\r\n      statusCode: 405,\r\n      headers,\r\n      body: JSON.stringify({ error: 'Method not allowed' })\r\n    };\r\n  }\r\n\r\n  try {\r\n    // Validar que el body existe\r\n    if (!event.body) {\r\n      console.log('\u274C No hay body en la request');\r\n      return {\r\n        statusCode: 400,\r\n        headers,\r\n        body: JSON.stringify({ error: 'No body provided' })\r\n      };\r\n    }\r\n\r\n    const { constructionData } = JSON.parse(event.body);\r\n    console.log('\uD83D\uDCE5 Datos recibidos:', JSON.stringify(constructionData, null, 2));\r\n\r\n    // Validar que tengamos los datos necesarios\r\n    if (!constructionData || !constructionData.name) {\r\n      console.log('\u274C Faltan datos de construcci\u00F3n');\r\n      return {\r\n        statusCode: 400,\r\n        headers,\r\n        body: JSON.stringify({ error: 'Faltan datos de construcci\u00F3n' })\r\n      };\r\n    }\r\n\r\n    // Verificar token de HubSpot\r\n    const hubspotToken = process.env.HUBSPOT_ACCESS_TOKEN;\r\n    if (!hubspotToken) {\r\n      console.log('\u274C Token de HubSpot no configurado');\r\n      return {\r\n        statusCode: 500,\r\n        headers,\r\n        body: JSON.stringify({ error: 'HubSpot token not configured' })\r\n      };\r\n    }\r\n\r\n    console.log('\uD83D\uDD11 Token encontrado:', hubspotToken.substring(0, 10) + '...');\r\n\r\n    // Owner ID configurable para producci\u00F3n\r\n    const ownerId = process.env.HUBSPOT_OWNER_ID || '158118434';\r\n    console.log('\uD83D\uDC64 Owner ID usado:', ownerId);\r\n\r\n    // Crear deal en HubSpot con todos los campos\r\n    const dealProperties = {\r\n      properties: {\r\n        dealname: constructionData.name,\r\n        dealstage: '205747816',\r\n        hubspot_owner_id: ownerId, // \u2705 Configurable por entorno\r\n        enviar_presupuesto: true,\r\n        direccion_obra: constructionData.address || '',\r\n        codigo_postal_obra: constructionData.postal_code || '',\r\n        municipio_obra: constructionData.municipality || '',\r\n        razon_social_peticionario: constructionData.company_name || '',\r\n        cif_peticionario: constructionData.company_cif || '',\r\n        domicilio_fiscal_peticionario: constructionData.fiscal_address || '',\r\n        numero_viviendas: constructionData.housing_count || 0,\r\n        acometida: constructionData.acometida || '',\r\n        servicios_obra: Array.isArray(constructionData.servicios_obra) \r\n          ? constructionData.servicios_obra.join(';') \r\n          : constructionData.servicios_obra || '',\r\n      }\r\n    };\r\n\r\n    console.log('\uD83D\uDE80 Enviando a HubSpot:', JSON.stringify(dealProperties, null, 2));\r\n\r\n    const response = await fetch('https://api.hubapi.com/crm/v3/objects/deals', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${hubspotToken}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(dealProperties),\r\n    });\r\n\r\n    console.log('\uD83D\uDCE1 Respuesta HubSpot status:', response.status);\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.log('\u274C Error de HubSpot:', errorText);\r\n      throw new Error(`HubSpot API Error: ${response.status} - ${errorText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    console.log('\u2705 Deal creado exitosamente:', result.id);\r\n\r\n    return {\r\n      statusCode: 200,\r\n      headers,\r\n      body: JSON.stringify({\r\n        success: true,\r\n        dealId: result.id,\r\n        message: 'Deal creado exitosamente'\r\n      }),\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error('\uD83D\uDCA5 Error en funci\u00F3n:', error);\r\n    console.error('\uD83D\uDCA5 Stack trace:', error.stack);\r\n    return {\r\n      statusCode: 500,\r\n      headers,\r\n      body: JSON.stringify({\r\n        success: false,\r\n        error: 'Error interno del servidor',\r\n        details: error.message\r\n      }),\r\n    };\r\n  }\r\n}"],
  "mappings": "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",
  "names": []
}
