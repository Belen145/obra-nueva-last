{
  "version": 3,
  "sources": ["../../../../Documents/Obra Nueva/obra-nueva-last/netlify/functions/slack-notify.js"],
  "sourceRoot": "C:/Users/Zenova/AppData/Local/Temp/tmp-11068-7gqfCaKIH06y",
  "sourcesContent": ["exports.handler = async (event, context) => {\r\n  // Headers CORS\r\n  const headers = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n    'Content-Type': 'application/json'\r\n  };\r\n\r\n  // Manejar preflight CORS\r\n  if (event.httpMethod === 'OPTIONS') {\r\n    return {\r\n      statusCode: 200,\r\n      headers,\r\n      body: ''\r\n    };\r\n  }\r\n\r\n  if (event.httpMethod !== 'POST') {\r\n    return {\r\n      statusCode: 405,\r\n      headers,\r\n      body: JSON.stringify({ error: 'M\u00E9todo no permitido' })\r\n    };\r\n  }\r\n\r\n  try {\r\n    console.log('\uD83D\uDE80 Funci\u00F3n slack-notify iniciada');\r\n    \r\n    const webhookUrl = process.env.SLACK_WEBHOOK_URL;\r\n    console.log('\uD83D\uDD0D Webhook URL configurada:', !!webhookUrl);\r\n    \r\n    if (!webhookUrl) {\r\n      console.log('\u274C SLACK_WEBHOOK_URL no configurada');\r\n      return {\r\n        statusCode: 400,\r\n        headers,\r\n        body: JSON.stringify({ error: 'Webhook URL no configurada' })\r\n      };\r\n    }\r\n\r\n    // Parse del body de la request\r\n    const requestBody = JSON.parse(event.body || '{}');\r\n    console.log('\uD83D\uDCE8 Datos recibidos:', requestBody);\r\n\r\n    // Crear el mensaje para Slack\r\n    const slackMessage = {\r\n      text: `\uD83D\uDCCB *Nuevo documento subido*`,\r\n      blocks: [\r\n        {\r\n          type: \"header\",\r\n          text: {\r\n            type: \"plain_text\",\r\n            text: \"\uD83D\uDCCB Nuevo documento subido\"\r\n          }\r\n        },\r\n        {\r\n          type: \"section\",\r\n          fields: [\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83C\uDFD7\uFE0F Obra:*\\n${requestBody.obraName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDCC4 Documento:*\\n${requestBody.documentName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDC64 Usuario:*\\n${requestBody.userName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDCE7 Email:*\\n${requestBody.userEmail}`\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: \"section\",\r\n          text: {\r\n            type: \"mrkdwn\",\r\n            text: `*\uD83D\uDD17 Enlace:* <${requestBody.downloadUrl}|Ver documento>`\r\n          }\r\n        }\r\n      ]\r\n    };\r\n\r\n    console.log('\uD83D\uDCE4 Enviando mensaje a Slack...');\r\n\r\n    const response = await fetch(webhookUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(slackMessage),\r\n    });\r\n\r\n    console.log('\uD83D\uDCE1 Respuesta de Slack:', response.status, response.statusText);\r\n\r\n    if (response.ok) {\r\n      console.log('\u2705 Notificaci\u00F3n enviada exitosamente');\r\n      return {\r\n        statusCode: 200,\r\n        headers,\r\n        body: JSON.stringify({ \r\n          success: true, \r\n          message: 'Notificaci\u00F3n enviada a Slack' \r\n        })\r\n      };\r\n    } else {\r\n      const errorText = await response.text();\r\n      console.log('\u274C Error de Slack:', errorText);\r\n      return {\r\n        statusCode: 400,\r\n        headers,\r\n        body: JSON.stringify({ \r\n          error: 'Error al enviar a Slack', \r\n          details: errorText \r\n        })\r\n      };\r\n    }\r\n  } catch (error) {\r\n    console.log('\u274C Error en funci\u00F3n:', error);\r\n    return {\r\n      statusCode: 500,\r\n      headers,\r\n      body: JSON.stringify({ \r\n        error: 'Error interno', \r\n        details: error.message \r\n      })\r\n    };\r\n  }\r\n};"],
  "mappings": "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",
  "names": []
}
