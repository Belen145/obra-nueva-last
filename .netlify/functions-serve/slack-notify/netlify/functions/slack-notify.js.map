{
  "version": 3,
  "sources": ["../../../../Documents/Obra Nueva/obra-nueva-last/netlify/functions/slack-notify.ts"],
  "sourceRoot": "C:/Users/Zenova/AppData/Local/Temp/tmp-11068-LSKECChIoZN2",
  "sourcesContent": ["import { Handler } from '@netlify/functions';\r\n\r\nexport const handler: Handler = async (event, context) => {\r\n  // Manejar preflight requests de CORS\r\n  if (event.httpMethod === 'OPTIONS') {\r\n    return {\r\n      statusCode: 200,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n      },\r\n      body: '',\r\n    };\r\n  }\r\n\r\n  // Solo permitir POST requests\r\n  if (event.httpMethod !== 'POST') {\r\n    return {\r\n      statusCode: 405,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n      },\r\n      body: JSON.stringify({ error: 'M\u00E9todo no permitido' }),\r\n    };\r\n  }\r\n\r\n  // Verificar que el webhook URL est\u00E9 configurado\r\n  const webhookUrl = process.env.SLACK_WEBHOOK_URL;\r\n  if (!webhookUrl) {\r\n    console.error('\u274C Slack webhook URL no configurada');\r\n    return {\r\n      statusCode: 500,\r\n      body: JSON.stringify({ error: 'Slack webhook no configurado' }),\r\n    };\r\n  }\r\n\r\n  try {\r\n    // Parse del body de la request\r\n    const requestBody = JSON.parse(event.body || '{}');\r\n    console.log('\uD83D\uDCE8 Netlify Function: Recibiendo petici\u00F3n para Slack:', requestBody);\r\n\r\n    // Crear el mensaje para Slack\r\n    const slackMessage = {\r\n      text: `\uD83D\uDCCB *Nuevo documento subido*`,\r\n      blocks: [\r\n        {\r\n          type: \"header\",\r\n          text: {\r\n            type: \"plain_text\",\r\n            text: \"\uD83D\uDCCB Nuevo documento subido\"\r\n          }\r\n        },\r\n        {\r\n          type: \"section\",\r\n          fields: [\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83C\uDFD7\uFE0F Obra:*\\n${requestBody.obraName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDCC4 Documento:*\\n${requestBody.documentName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDC64 Usuario:*\\n${requestBody.userName}`\r\n            },\r\n            {\r\n              type: \"mrkdwn\",\r\n              text: `*\uD83D\uDCE7 Email:*\\n${requestBody.userEmail}`\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: \"section\",\r\n          text: {\r\n            type: \"mrkdwn\",\r\n            text: `*\uD83D\uDD17 Enlace:* <${requestBody.downloadUrl}|Ver documento>`\r\n          }\r\n        }\r\n      ]\r\n    };\r\n\r\n    console.log('\uD83D\uDCE4 Netlify Function: Enviando a Slack...');\r\n\r\n    // Enviar a Slack\r\n    const response = await fetch(webhookUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(slackMessage),\r\n    });\r\n\r\n    console.log('\uD83D\uDCE1 Netlify Function: Respuesta de Slack:', {\r\n      status: response.status,\r\n      statusText: response.statusText,\r\n      ok: response.ok\r\n    });\r\n\r\n    if (response.ok) {\r\n      console.log('\u2705 Netlify Function: Notificaci\u00F3n enviada exitosamente');\r\n      return {\r\n        statusCode: 200,\r\n        headers: {\r\n          'Access-Control-Allow-Origin': '*',\r\n          'Access-Control-Allow-Headers': 'Content-Type',\r\n          'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n        },\r\n        body: JSON.stringify({ success: true, message: 'Notificaci\u00F3n enviada a Slack' }),\r\n      };\r\n    } else {\r\n      const errorText = await response.text();\r\n      console.error('\u274C Netlify Function: Error de Slack:', errorText);\r\n      return {\r\n        statusCode: 500,\r\n        headers: {\r\n          'Access-Control-Allow-Origin': '*',\r\n          'Access-Control-Allow-Headers': 'Content-Type',\r\n          'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n        },\r\n        body: JSON.stringify({ \r\n          success: false, \r\n          error: 'Error enviando a Slack',\r\n          details: errorText \r\n        }),\r\n      };\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('\u274C Netlify Function: Error:', error);\r\n    return {\r\n      statusCode: 500,\r\n      headers: {\r\n        'Access-Control-Allow-Origin': '*',\r\n        'Access-Control-Allow-Headers': 'Content-Type',\r\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n      },\r\n      body: JSON.stringify({ \r\n        success: false, \r\n        error: 'Error interno del servidor',\r\n        details: error instanceof Error ? error.message : 'Error desconocido'\r\n      }),\r\n    };\r\n  }\r\n};"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEO,IAAM,UAAmB,OAAO,OAAO,YAAY;AAExD,MAAI,MAAM,eAAe,WAAW;AAClC,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,+BAA+B;AAAA,QAC/B,gCAAgC;AAAA,QAChC,gCAAgC;AAAA,MAClC;AAAA,MACA,MAAM;AAAA,IACR;AAAA,EACF;AAGA,MAAI,MAAM,eAAe,QAAQ;AAC/B,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,+BAA+B;AAAA,QAC/B,gCAAgC;AAAA,QAChC,gCAAgC;AAAA,MAClC;AAAA,MACA,MAAM,KAAK,UAAU,EAAE,OAAO,yBAAsB,CAAC;AAAA,IACvD;AAAA,EACF;AAGA,QAAM,aAAa,QAAQ,IAAI;AAC/B,MAAI,CAAC,YAAY;AACf,YAAQ,MAAM,yCAAoC;AAClD,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,MAAM,KAAK,UAAU,EAAE,OAAO,+BAA+B,CAAC;AAAA,IAChE;AAAA,EACF;AAEA,MAAI;AAEF,UAAM,cAAc,KAAK,MAAM,MAAM,QAAQ,IAAI;AACjD,YAAQ,IAAI,kEAAwD,WAAW;AAG/E,UAAM,eAAe;AAAA,MACnB,MAAM;AAAA,MACN,QAAQ;AAAA,QACN;AAAA,UACE,MAAM;AAAA,UACN,MAAM;AAAA,YACJ,MAAM;AAAA,YACN,MAAM;AAAA,UACR;AAAA,QACF;AAAA,QACA;AAAA,UACE,MAAM;AAAA,UACN,QAAQ;AAAA,YACN;AAAA,cACE,MAAM;AAAA,cACN,MAAM;AAAA,EAAgB,YAAY,QAAQ;AAAA,YAC5C;AAAA,YACA;AAAA,cACE,MAAM;AAAA,cACN,MAAM;AAAA,EAAoB,YAAY,YAAY;AAAA,YACpD;AAAA,YACA;AAAA,cACE,MAAM;AAAA,cACN,MAAM;AAAA,EAAkB,YAAY,QAAQ;AAAA,YAC9C;AAAA,YACA;AAAA,cACE,MAAM;AAAA,cACN,MAAM;AAAA,EAAgB,YAAY,SAAS;AAAA,YAC7C;AAAA,UACF;AAAA,QACF;AAAA,QACA;AAAA,UACE,MAAM;AAAA,UACN,MAAM;AAAA,YACJ,MAAM;AAAA,YACN,MAAM,wBAAiB,YAAY,WAAW;AAAA,UAChD;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAEA,YAAQ,IAAI,iDAA0C;AAGtD,UAAM,WAAW,MAAM,MAAM,YAAY;AAAA,MACvC,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,MAClB;AAAA,MACA,MAAM,KAAK,UAAU,YAAY;AAAA,IACnC,CAAC;AAED,YAAQ,IAAI,mDAA4C;AAAA,MACtD,QAAQ,SAAS;AAAA,MACjB,YAAY,SAAS;AAAA,MACrB,IAAI,SAAS;AAAA,IACf,CAAC;AAED,QAAI,SAAS,IAAI;AACf,cAAQ,IAAI,+DAAuD;AACnE,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS;AAAA,UACP,+BAA+B;AAAA,UAC/B,gCAAgC;AAAA,UAChC,gCAAgC;AAAA,QAClC;AAAA,QACA,MAAM,KAAK,UAAU,EAAE,SAAS,MAAM,SAAS,kCAA+B,CAAC;AAAA,MACjF;AAAA,IACF,OAAO;AACL,YAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAQ,MAAM,4CAAuC,SAAS;AAC9D,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS;AAAA,UACP,+BAA+B;AAAA,UAC/B,gCAAgC;AAAA,UAChC,gCAAgC;AAAA,QAClC;AAAA,QACA,MAAM,KAAK,UAAU;AAAA,UACnB,SAAS;AAAA,UACT,OAAO;AAAA,UACP,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EAEF,SAAS,OAAO;AACd,YAAQ,MAAM,mCAA8B,KAAK;AACjD,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,+BAA+B;AAAA,QAC/B,gCAAgC;AAAA,QAChC,gCAAgC;AAAA,MAClC;AAAA,MACA,MAAM,KAAK,UAAU;AAAA,QACnB,SAAS;AAAA,QACT,OAAO;AAAA,QACP,SAAS,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MACpD,CAAC;AAAA,IACH;AAAA,EACF;AACF;",
  "names": []
}
